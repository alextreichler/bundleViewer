<!DOCTYPE html>
<html lang="en">
<head>
    <title>System Status</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/theme.js"></script>
    <style>
        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background-color: var(--header-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .stat-label {
            font-weight: bold;
            color: var(--text-color);
        }
        .stat-value {
            font-family: monospace;
        }
        .progress-bar {
            background-color: var(--border-color);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            background-color: var(--link-color);
            height: 100%;
        }
        .warning { background-color: #ff9800; }
        .danger { background-color: #f44336; }
    </style>
</head>
<body>
    					
    					</div>    	    {{template "nav" (dict "Active" "System" "Sessions" .Sessions "ActivePath" .ActivePath "LogsOnly" .LogsOnly)}}
    	    <h1>System Status: {{.NodeHostname}}</h1>    <div class="system-grid">
        <!-- System Info -->
        <div class="card">
            <h3>System Info</h3>
            {{if .System.Uname.KernelName}}
            <div class="stat-row">
                <span class="stat-label" title="The operating system kernel name (e.g., Linux)">Kernel Name</span>
                <span class="stat-value">{{.System.Uname.KernelName}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="The network node hostname">Hostname</span>
                <span class="stat-value">{{.System.Uname.Hostname}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="The kernel release version (often includes OS-specific suffixes like .el8 for RHEL 8)">Kernel Release</span>
                <span class="stat-value">{{.System.Uname.KernelRelease}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="Detailed build information and compilation timestamp">Kernel Version</span>
                <span class="stat-value" style="font-size: 0.85em;">{{.System.Uname.KernelVersion}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="The machine hardware architecture (e.g., x86_64, aarch64)">Arch</span>
                <span class="stat-value">{{.System.Uname.Machine}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="The operating system type (usually GNU/Linux)">Kernel OS</span>
                <span class="stat-value">{{.System.Uname.OperatingSystem}}</span>
            </div>
            {{if .System.Uname.Distro}}
            <div class="stat-row">
                <span class="stat-label" title="Inferred Linux distribution based on kernel release patterns">OS Distribution</span>
                <span class="stat-value" style="font-weight: bold; color: var(--link-color);">{{.System.Uname.Distro}}</span>
            </div>
            {{end}}
            <div class="stat-row">
                <span class="stat-label" title="Whether the system is likely running in a container or on a physical/virtual host">Environment</span>
                <span class="stat-value">
                    {{if .System.Uname.IsContainer}}
                    <span class="status-tag status-warning">Container / K8s</span>
                    {{else}}
                    <span class="status-tag status-healthy">Physical / VM</span>
                    {{end}}
                </span>
            </div>
            {{if .System.Uname.CloudProvider}}
            <div class="stat-row">
                <span class="stat-label" title="Inferred cloud provider based on hostname patterns">Cloud Provider</span>
                <span class="stat-value" style="font-weight: bold;">{{.System.Uname.CloudProvider}}</span>
            </div>
            {{end}}
            {{if .System.DMI.Manufacturer}}
            <div class="stat-row">
                <span class="stat-label">Manufacturer</span>
                <span class="stat-value">{{.System.DMI.Manufacturer}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Product</span>
                <span class="stat-value">{{.System.DMI.Product}}</span>
            </div>
            {{end}}
            {{if .System.Dig.Status}}
             <div class="stat-row">
                <span class="stat-label">DNS Status</span>
                <span class="stat-value" style="{{if ne .System.Dig.Status "NOERROR"}}color: red;{{end}}">{{.System.Dig.Status}}</span>
            </div>
            {{end}}
            {{if .System.CPU.ModelName}}
            <h4 style="margin-top: 15px; margin-bottom: 5px;">CPU <span style="font-weight: normal; font-size: 0.7em; color: var(--text-color-light);">(Seastar/Vectorized Support)</span></h4>
            <div class="stat-row">
                <span class="stat-label">Model</span>
                <span class="stat-value" title="{{.System.CPU.ModelName}}">{{slice .System.CPU.ModelName 0 30}}...</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">MHz</span>
                <span class="stat-value">{{.System.CPU.Mhz}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cache</span>
                <span class="stat-value">{{.System.CPU.CacheSize}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Flags</span>
                <span class="stat-value" style="font-size: 0.8em;" title="Look for: avx, avx2, sse4_2 (Critical for CRC32C)">{{range .System.CPU.Flags}}{{.}} {{end}}</span>
            </div>
            {{end}}
            {{if .System.CmdLine}}
            <h4 style="margin-top: 15px; margin-bottom: 5px;">Boot Params <span style="font-weight: normal; font-size: 0.7em; color: var(--text-color-light);">(Latency Tuning)</span></h4>
            <div style="font-family: monospace; font-size: 0.8em; word-break: break-all; max-height: 60px; overflow-y: auto; color: var(--text-color-light);" title="Look for: isolcpus, hugepages, max_cstate=0">
                {{.System.CmdLine}}
            </div>
            {{end}}
            {{else}}
            <p>System info not available.</p>
            {{end}}
        </div>

        <!-- RAID Status -->
        {{if .System.MDStat.Arrays}}
        <div class="card">
            <h3>Software RAID (MD)</h3>
            <p style="font-size: 0.9em; margin-bottom: 10px;"><em>Degraded arrays cause high latency.</em></p>
            <p><strong>Personalities:</strong> {{range .System.MDStat.Personalities}}{{.}} {{end}}</p>
            {{range .System.MDStat.Arrays}}
            <div style="border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px;">
                <div class="stat-row">
                    <span class="stat-label">{{.Name}}</span>
                    <span class="stat-value">{{.State}}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Status</span>
                    <span class="stat-value" style="{{if contains .Status "_"}}color: red; font-weight: bold;{{end}}">{{.Status}}</span>
                </div>
                 <div class="stat-row">
                    <span class="stat-label">Size</span>
                    <span class="stat-value">{{formatBytes .Blocks}} (Blocks)</span>
                </div>
                <p style="font-size: 0.8em; color: var(--text-color-light);">{{range .Devices}}{{.}} {{end}}</p>
            </div>
            {{end}}
        </div>
        {{end}}
        
        <!-- VM Stats -->
        <div class="card">
            <h3>VM Statistics</h3>
             {{if .System.VMStat.ContextSwitches}}
            <div class="stat-row">
                <span class="stat-label">Context Switches</span>
                <span class="stat-value">{{.System.VMStat.ContextSwitches}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Forks</span>
                <span class="stat-value">{{.System.VMStat.ProcessesForked}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Procs Running</span>
                <span class="stat-value">{{.System.VMStat.ProcsRunning}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label" title="Processes waiting for I/O. > 0 indicates disk saturation.">Procs Blocked</span>
                <span class="stat-value" {{if gt .System.VMStat.ProcsBlocked 0}}style="color: red; font-weight: bold;"{{end}}>{{.System.VMStat.ProcsBlocked}}</span>
            </div>
            {{else}}
            <p>VM statistics not available.</p>
            {{end}}
        </div>

        <!-- Live Load (VMStat TS) -->
        {{if .System.VMStatAnalysis.Samples}}
        <div class="card">
            <h3>Live System Load <span style="font-weight: normal; font-size: 0.7em; color: var(--text-color-light);">
(During Collection)</span></h3>
            <p style="font-size: 0.8em; color: var(--text-color-light); margin-bottom: 10px; line-height: 1.4;">
                <strong>Run Queue (r):</strong> Should be &lt; Cores. High = CPU Saturation.<br>
                <strong>Blocked (b):</strong> Should be near 0. High = Disk Saturation.<br>
                <strong>IO Wait (wa):</strong> Should be low. High = Disk Bottleneck.
            </p>
            <div class="stat-row">
                <span class="stat-label">Run Queue (r)</span>
                <span class="stat-value">Avg: {{printf "%.1f" .System.VMStatAnalysis.AvgRunnable}} / Max: {{.System.VMStatAnalysis.MaxRunnable}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Blocked (b)</span>
                <span class="stat-value" {{if gt .System.VMStatAnalysis.AvgBlocked 1.0}}style="color: red; font-weight: bold;"{{end}}>Avg: {{printf "%.1f" .System.VMStatAnalysis.AvgBlocked}} / Max: {{.System.VMStatAnalysis.MaxBlocked}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">IO Wait (wa)</span>
                <span class="stat-value" {{if gt .System.VMStatAnalysis.AvgIOWait 10.0}}style="color: red; font-weight: bold;"{{end}}>Avg: {{printf "%.1f" .System.VMStatAnalysis.AvgIOWait}}% / Max: {{.System.VMStatAnalysis.MaxIOWait}}%</span>
            </div>
        </div>
        {{end}}

        <!-- Load Average -->
        <div class="card">
            <h3>Load Average</h3>
            {{if .System.CoreCount}}
                <p style="font-size: 0.9em; color: var(--text-color-light); margin-bottom: 10px;">
                    <strong>CPU Cores: {{.System.CoreCount}}</strong><br>
                    Load > {{.System.CoreCount}} indicates saturation.
                </p>
            {{end}}
            <div class="stat-row">
                <span class="stat-label">1 min</span>
                <span class="stat-value" {{if and .System.CoreCount (gt .System.Load.OneMin (float64 .System.CoreCount))}}style="color: red; font-weight: bold;"{{end}}>{{.System.Load.OneMin}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">5 min</span>
                <span class="stat-value" {{if and .System.CoreCount (gt .System.Load.FiveMin (float64 .System.CoreCount))}}style="color: red; font-weight: bold;"{{end}}>{{.System.Load.FiveMin}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">15 min</span>
                <span class="stat-value" {{if and .System.CoreCount (gt .System.Load.FifteenMin (float64 .System.CoreCount))}}style="color: red; font-weight: bold;"{{end}}>{{.System.Load.FifteenMin}}</span>
            </div>
        </div>
        </div>

        <!-- Memory -->
        <div class="card">
            <h3>Memory</h3>
            <div class="stat-row">
                <span class="stat-label">Total</span>
                <span class="stat-value">{{formatBytes .System.Memory.Total}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Used</span>
                <span class="stat-value">{{formatBytes .System.Memory.Used}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Free</span>
                <span class="stat-value">{{formatBytes .System.Memory.Free}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Available</span>
                <span class="stat-value">{{formatBytes .System.Memory.Available}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Swap Used</span>
                <span class="stat-value">{{formatBytes .System.Memory.SwapUsed}}</span>
            </div>
            
            {{if .System.MemInfo.AnonHugePages}}
            <h4 style="margin-top: 15px; margin-bottom: 5px;">Extended Mem</h4>
            <div class="stat-row">
                <span class="stat-label">AnonHugePages</span>
                <span class="stat-value">{{formatBytes .System.MemInfo.AnonHugePages}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Slab</span>
                <span class="stat-value">{{formatBytes .System.MemInfo.Slab}}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Dirty</span>
                <span class="stat-value">{{formatBytes .System.MemInfo.Dirty}}</span>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Disk Usage -->
    <div class="card">
        <h3>File Systems</h3>
        <table class="sortable-table">
            <thead>
                <tr>
                    <th>Mount</th>
                    <th>Filesystem</th>
                    <th>Type</th>
                    <th>Size</th>
                    <th>Used</th>
                    <th>Avail</th>
                    <th>Use%</th>
                </tr>
            </thead>
            <tbody>
                {{range .System.FileSystems}}
                <tr>
                    <td>{{.MountPoint}}</td>
                    <td>{{.Filesystem}}</td>
                    <td>{{.Type}}</td>
                    <td>{{formatBytes .Total}}</td>
                    <td>{{formatBytes .Used}}</td>
                    <td>{{formatBytes .Available}}</td>
                    <td>
                        {{.UsePercent}}
                        {{if contains .UsePercent "%"}}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{.UsePercent}};"></div>
                        </div>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <!-- Active Connections -->
    {{if .System.Connections}}
    <div class="card" style="margin-top: 20px;">
        <h3>Active TCP/UDP Connections</h3>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex: 1; min-width: 200px;">
                <h4>By State</h4>
                <table class="sortable-table">
                    <thead><tr><th>State</th><th>Count</th></tr></thead>
                    <tbody>
                        {{range $state, $count := .System.ConnSummary.ByState}}
                        <tr><td>{{$state}}</td><td>{{$count}}</td></tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <h4>Top Ports (Local)</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="sortable-table">
                        <thead><tr><th>Port</th><th>Count</th></tr></thead>
                        <tbody>
                            {{range .System.ConnSummary.SortedByPort}}
                            <tr><td>{{.Port}}</td><td>{{.Count}}</td></tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="flex: 1; min-width: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                 <span style="font-size: 3em; font-weight: bold; color: var(--link-color);">{{.System.ConnSummary.Total}}</span>
                 <span style="text-transform: uppercase; letter-spacing: 1px; color: var(--text-color);">Total Connections</span>
            </div>
        </div>

        <p><em>Filtered to exclude most localhost traffic unless relevant to Redpanda ports.</em></p>
        <div style="max-height: 500px; overflow-y: auto;">
            <table class="sortable-table">
                <thead>
                    <tr>
                        <th>Proto</th>
                        <th>State</th>
                        <th>Local Address</th>
                        <th>Peer Address</th>
                        <th>Recv-Q</th>
                        <th>Send-Q</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .System.Connections}}
                    <tr>
                        <td>{{.Netid}}</td>
                        <td>{{.State}}</td>
                        <td>{{.LocalAddr}}</td>
                        <td>{{.PeerAddr}}</td>
                        <td>{{.RecvQ}}</td>
                        <td>{{.SendQ}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
    {{end}}

    <!-- Kernel Config -->
    <div class="card" style="margin-top: 20px;">
        <h3>Kernel Configuration (Sysctl)</h3>
        <table class="sortable-table">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {{range $k, $v := .System.Sysctl}}
                <tr>
                    <td>{{$k}}</td>
                    <td>{{$v}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

</body>
</html>
