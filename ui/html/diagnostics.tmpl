<!DOCTYPE html>
<html lang="en">
<head>
	<title>Diagnostics - Bundle Viewer</title>
	<link rel="stylesheet" href="/static/style.css">
	<script src="/static/theme.js"></script>
	<script src="/static/htmx.min.js"></script>
    <style>
        .status-pass { color: var(--success-color, #28a745); font-weight: bold; }
        .status-warning { color: var(--warning-color, #ffc107); font-weight: bold; }
        .status-critical { color: var(--danger-color, #dc3545); font-weight: bold; }
        .status-info { color: var(--info-color, #17a2b8); font-weight: bold; }
        
        .diag-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .diag-table th, .diag-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }
        .diag-table th {
            background-color: var(--header-bg-color);
        }
        .remediation-cell {
            white-space: pre-line;
            max-width: 500px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
	
	</div>
    {{template "nav" .}}

	<h2>Node: {{.NodeHostname}} - Diagnostics Report</h2>

    <p>This report runs automated checks against best-practice configurations and system health indicators.</p>

    {{if .Syslog.OOMEvents}}
    <div style="margin-bottom: 20px; border: 1px solid #dc3545; border-radius: 8px; padding: 20px; background-color: rgba(220, 53, 69, 0.05);">
        <h3 style="color: #dc3545; margin-top: 0;">⚠️ Critical: OOM Killer Events Detected</h3>
        <p>The system Out-Of-Memory (OOM) killer has terminated processes. This indicates severe memory pressure.</p>
        <table class="diag-table">
            <thead>
                <tr>
                    <th>Kernel Time</th>
                    <th>Invoked By</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody>
                {{range .Syslog.OOMEvents}}
                <tr>
                    <td style="font-family: monospace;">{{.Timestamp}}</td>
                    <td>{{.ProcessName}}</td>
                    <td>{{.Message}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{end}}

    <table class="diag-table">
        <thead>
            <tr>
                <th>Status</th>
                <th>Category</th>
                <th>Check</th>
                <th>Current Value</th>
                <th>Expected</th>
                <th>Recommendation</th>
            </tr>
        </thead>
        <tbody>
            {{range .Report.Results}}
            <tr>
                <td><span class="insight-badge severity-{{.Status}}">{{.Status}}</span></td>
                <td>{{.Category}}</td>
                <td title="{{.Description}}">{{.Name}}</td>
                <td style="font-family: monospace;">{{.CurrentValue}}</td>
                <td style="font-family: monospace;">{{.ExpectedValue}}</td>
                <td class="remediation-cell">{{.Remediation}}</td>
            </tr>
            {{end}}
        </tbody>
    </table>

    <div style="margin-top: 40px; border: 1px solid #17a2b8; border-radius: 8px; padding: 20px; background-color: rgba(23, 162, 184, 0.05);">
        <h3 style="color: #17a2b8; margin-top: 0;">ℹ️ Understanding Redpanda CPU & Threading</h3>
        <p><strong>OS CPU vs. Reactor Utilization:</strong> Redpanda uses the Seastar framework, which eagerly polls for I/O (network/disk) even when idle. This causes the OS to report ~100% CPU usage. This is normal. The <em>Reactor Utilization</em> metric tracks actual useful work.</p>
        <p><strong>Threaded Fallbacks:</strong> Most I/O is asynchronous (AIO), but some operations (like file metadata or retries) must use a fallback thread. High "Threaded Fallbacks" counts can indicate hidden latency sources.</p>
        <p><strong>Stalls:</strong> A "stall" occurs when a task hogs the CPU for too long (>0.5ms quota), preventing other tasks (like heartbeats) from running. Long stalls (>25ms) are logged and can cause leadership loss.</p>
    </div>

</body>
</html>
