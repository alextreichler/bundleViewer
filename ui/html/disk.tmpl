<!DOCTYPE html>
<html>
<head>
	<title>Disk Overview</title>
	<link rel="stylesheet" href="/static/style.css">
	<link rel="stylesheet" href="/static/disk_viz.css">
	<script src="/static/theme.js"></script>
</head>
<body>
	<div id="loading-overlay">
		<div id="loading-box">
			<h2>Loading...</h2>
			<div id="progress-container">
				<div id="progress-bar">0%</div>
			</div>
            <p id="loading-status" style="margin-top: 1rem; color: var(--text-color-muted); font-size: 0.875rem; text-align: center;"></p>
		</div>
	</div>
    {{template "nav" .}}
	<h1>Disk Overview</h1>

    <div class="viz-container">
        <h2 class="viz-title">ðŸ“Š Topic Disk Distribution</h2>
        <p style="margin-bottom: 1rem; color: var(--text-color-muted); font-size: 0.9rem;">
            Relative disk space usage across topics. Hover for details.
        </p>
        <div class="disk-treemap">
            {{$total := toInt64 0}}
            {{range .TopicsDiskInfo}}{{$total = add64 $total (toInt64 .TotalSize)}}{{end}}
            
            {{$colors := list "rgb(52, 152, 219)" "rgb(46, 204, 113)" "rgb(155, 89, 182)" "rgb(241, 196, 15)" "rgb(230, 126, 34)" "rgb(231, 76, 60)" "rgb(149, 165, 166)" "rgb(52, 73, 94)"}}
            
                        {{range $i, $topic := .TopicsDiskInfo}}
            
                            {{$pct := div (toFloat64 $topic.TotalSize) (toFloat64 $total)}}
            
                            {{if gt $pct 0.01}}
            
             {{/* Only show if > 1% */}}
                <div class="treemap-item" 
                     title="{{$topic.Name}}: {{formatBytes $topic.TotalSize}} ({{printf "%.1f" (mul $pct 100.0)}}%)"
                     style="width: {{printf "%.2f" (mul $pct 100.0)}}%; background-color: {{index $colors (mod $i 8)}};">
                    <div class="treemap-label">{{$topic.Name}}</div>
                </div>
                {{end}}
            {{end}}
        </div>
    </div>

	<h2>Node: {{.NodeHostname}}</h2>

	<h2>Overall Disk Usage</h2>
	<table>
		<tbody>
			<tr>
				<th>Total Data Disk Space</th>
				<td>{{.DataDiskStats.TotalBytes | formatBytes}}</td>
			</tr>
			<tr>
				<th>Free Data Disk Space</th>
				<td>{{.DataDiskStats.FreeBytes | formatBytes}}</td>
			</tr>
			<tr>
				<th>Used Data Disk Space</th>
				<td>{{ (sub .DataDiskStats.TotalBytes .DataDiskStats.FreeBytes) | formatBytes}}</td>
			</tr>
			<tr>
				<th>Overall Free Space (from resource-usage.json)</th>
				<td>{{ (mul .ResourceUsage.FreeSpaceMB 1048576.0) | formatBytesFloat}}</td>
			</tr>
		</tbody>
	</table>

	<h2>Disk Usage per Topic</h2>
    {{if .StorageAnalysis}}
    <p>
        <strong>Active Topics:</strong> {{.StorageAnalysis.ActiveCount}} | 
        <strong>Orphaned Topics:</strong> {{.StorageAnalysis.OrphanedCount}}
    </p>
    {{end}}
	<table class="sortable-table">
		<thead>
			<tr>
				<th>Topic Name</th>
                <th>Active</th>
                <th>Segments</th>
				<th>Total Size</th>
			</tr>
		</thead>
		<tbody>
			{{range .TopicsDiskInfo}}
			<tr class="main-row" data-details-id="{{.Name}}-details">
				<td><a href="#" onclick="toggleVisibility('{{.Name}}-details'); return false;">{{.Name}}</a></td>
                <td data-value="{{if .Active}}1{{else}}0{{end}}" {{if not .Active}}style="color: var(--danger-color, red); font-weight: bold;"{{end}}>{{if .Active}}Yes{{else}}No{{end}}</td>
                <td data-value="{{.SegmentCount}}">{{.SegmentCount}}</td>
				<td data-value="{{.TotalSize}}">{{.TotalSize | formatBytes}}</td>
			</tr>
			<tr id="{{.Name}}-details" class="details-row" style="display:none;">
				<td colspan="4">
					<table>
						<thead>
							<tr>
								<th>Partition ID</th>
								<th>Size</th>
							</tr>
						</thead>
						<tbody>
							{{range $partitionID, $size := .Partitions}}
							<tr>
								<td>{{$partitionID}}</td>
								<td>{{$size | formatBytes}}</td>
							</tr>
							{{end}}
						</tbody>
					</table>
				</td>
			</tr>
			{{end}}
		</tbody>
	</table>

	<script src="/static/common.js"></script>
	<script src="/static/progress.js"></script>
	<script src="/static/tables.js"></script>
</body>
</html>
