<!DOCTYPE html>
<html>
<head>
	<title>Disk Overview</title>
	<link rel="stylesheet" href="/static/style.css">
	<link rel="stylesheet" href="/static/disk_viz.css">
	<script src="/static/theme.js"></script>
</head>
<body>
    {{template "nav" .}}
	<h1>Disk Overview</h1>

    <div class="viz-container">
        <h2 class="viz-title">ðŸ“Š Disk Space Analysis</h2>
        
        <div class="disk-usage-summary">
            <div class="summary-header">
                <h3 class="summary-title">Overall Node Disk Usage</h3>
                <div class="summary-stats">
                    Total: {{.DataDiskStats.TotalBytes | formatBytes}} | 
                    Free: {{.DataDiskStats.FreeBytes | formatBytes}} ({{percent .DataDiskStats.FreeBytes .DataDiskStats.TotalBytes | printf "%.1f"}}%)
                </div>
            </div>
            
            {{$usedBytes := sub .DataDiskStats.TotalBytes .DataDiskStats.FreeBytes}}
            {{$topicsBytes := toInt64 0}}
            {{range .TopicsDiskInfo}}{{$topicsBytes = add64 $topicsBytes (toInt64 .TotalSize)}}{{end}}
            {{$otherBytes := sub $usedBytes $topicsBytes}}
            {{if lt $otherBytes 0}}{{$otherBytes = 0}}{{end}}
            
            <div class="usage-bar-total">
                <div class="bar-segment topics" style="width: {{percent $topicsBytes .DataDiskStats.TotalBytes}}%" title="Topics: {{formatBytes $topicsBytes}}">
                    {{if gt (percent $topicsBytes .DataDiskStats.TotalBytes) 10.0}}Topics{{end}}
                </div>
                <div class="bar-segment other" style="width: {{percent $otherBytes .DataDiskStats.TotalBytes}}%" title="Other Files: {{formatBytes $otherBytes}}">
                    {{if gt (percent $otherBytes .DataDiskStats.TotalBytes) 10.0}}Other{{end}}
                </div>
                <div class="bar-segment free" style="width: {{percent .DataDiskStats.FreeBytes .DataDiskStats.TotalBytes}}%" title="Free Space: {{formatBytes .DataDiskStats.FreeBytes}}">
                    {{if gt (percent .DataDiskStats.FreeBytes .DataDiskStats.TotalBytes) 10.0}}Free{{end}}
                </div>
            </div>
            
            <div class="summary-legend">
                <div class="legend-item"><span class="legend-dot topics"></span> Topics ({{formatBytes $topicsBytes}})</div>
                <div class="legend-item"><span class="legend-dot other"></span> Other Files ({{formatBytes $otherBytes}})</div>
                <div class="legend-item"><span class="legend-dot free"></span> Free Space ({{formatBytes .DataDiskStats.FreeBytes}})</div>
            </div>
        </div>

        <h3 class="viz-title">ðŸ“‚ Topic Distribution</h3>
        <p style="margin-bottom: 1rem; color: var(--text-color-muted); font-size: 0.9rem;">
            Relative disk space usage across topics. Hover for details. Showing topics > 1% of total topic usage.
        </p>
        <div class="disk-treemap">
            {{$topicsTotal := toInt64 0}}
            {{range .TopicsDiskInfo}}{{$topicsTotal = add64 $topicsTotal (toInt64 .TotalSize)}}{{end}}
            {{if eq $topicsTotal 0}}{{$topicsTotal = 1}}{{end}}
            
            {{$colors := list "#3b82f6" "#10b981" "#f59e0b" "#ef4444" "#8b5cf6" "#ec4899" "#06b6d4" "#f97316" "#14b8a6" "#6366f1" "#4ade80" "#60a5fa" "#fbbf24" "#f87171" "#a78bfa" "#f472b6" "#22d3ee" "#fb923c" "#2dd4bf" "#818cf8"}}
            
            {{range $i, $topic := .TopicsDiskInfo}}
                {{$pct := div (toFloat64 $topic.TotalSize) (toFloat64 $topicsTotal)}}
                {{if gt $pct 0.01}}
                    <div class="treemap-item" 
                         onclick="window.location.hash = '#{{$topic.Name}}-row';"
                         title="{{$topic.Name}}: {{formatBytes $topic.TotalSize}} ({{printf "%.1f" (mul $pct 100.0)}}% of topics)"
                         style="flex: {{mul $pct 100.0}} 1 {{mul $pct 100.0}}%; background-color: {{index $colors (mod $i (len $colors))}};">
                        <div class="treemap-label">{{$topic.Name}}</div>
                        <div class="treemap-size">{{formatBytes $topic.TotalSize}}</div>
                    </div>
                {{end}}
            {{end}}
        </div>
    </div>

	<h2>Node: {{.NodeHostname}}</h2>

	<h2>Overall Disk Usage</h2>
	<table>
		<tbody>
			<tr>
				<th>Total Data Disk Space</th>
				<td>{{.DataDiskStats.TotalBytes | formatBytes}}</td>
			</tr>
			<tr>
				<th>Free Data Disk Space</th>
				<td>{{.DataDiskStats.FreeBytes | formatBytes}}</td>
			</tr>
			<tr>
				<th>Used Data Disk Space</th>
				<td>{{ (sub .DataDiskStats.TotalBytes .DataDiskStats.FreeBytes) | formatBytes}}</td>
			</tr>
			<tr>
				<th>Overall Free Space (from resource-usage.json)</th>
				<td>{{ (mul .ResourceUsage.FreeSpaceMB 1048576.0) | formatBytesFloat}}</td>
			</tr>
		</tbody>
	</table>

	<h2>Disk Usage per Topic</h2>
    {{if .StorageAnalysis}}
    <p>
        <strong>Active Topics:</strong> {{.StorageAnalysis.ActiveCount}} | 
        <strong>Orphaned Topics:</strong> {{.StorageAnalysis.OrphanedCount}}
    </p>
    {{end}}
	<table class="sortable-table">
		<thead>
			<tr>
				<th>Topic Name</th>
                <th>Active</th>
                <th>Segments</th>
				<th>Total Size</th>
			</tr>
		</thead>
		<tbody>
			{{range .TopicsDiskInfo}}
			<tr id="{{.Name}}-row" class="main-row" data-details-id="{{.Name}}-details">
				<td><a href="#" onclick="toggleVisibility('{{.Name}}-details'); return false;">{{.Name}}</a></td>
                <td data-value="{{if .Active}}1{{else}}0{{end}}" {{if not .Active}}style="color: var(--danger-color, red); font-weight: bold;"{{end}}>{{if .Active}}Yes{{else}}No{{end}}</td>
                <td data-value="{{.SegmentCount}}">{{.SegmentCount}}</td>
				<td data-value="{{.TotalSize}}">{{.TotalSize | formatBytes}}</td>
			</tr>
			<tr id="{{.Name}}-details" class="details-row" style="display:none;">
				<td colspan="4">
					<table>
						<thead>
							<tr>
								<th>Partition ID</th>
								<th>Size</th>
							</tr>
						</thead>
						<tbody>
							{{range $partitionID, $size := .Partitions}}
							<tr>
								<td>{{$partitionID}}</td>
								<td>{{$size | formatBytes}}</td>
							</tr>
							{{end}}
						</tbody>
					</table>
				</td>
			</tr>
			{{end}}
		</tbody>
	</table>

	<script src="/static/common.js"></script>
	<script src="/static/progress.js"></script>
	<script src="/static/tables.js"></script>
</body>
</html>
