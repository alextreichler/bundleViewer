<!DOCTYPE html>
<html lang="en">
<head>
    <title>Metrics Overview</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/theme.js"></script>
    <script src="/static/htmx.min.js"></script>
</head>
<body>
    <script src="/static/chart.js"></script>
    <script src="/static/metrics_view.js"></script>
    <style>
        .metric-card {
            background-color: var(--header-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .metric-label {
            color: var(--text-color-muted);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Custom Tooltip CSS */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            text-decoration: underline dotted;
        }
        .tooltip-container .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--card-bg);
            color: var(--text-color);
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above */
            left: 50%;
            margin-left: -100px; /* Center */
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.85em;
            font-weight: normal;
            pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    {{template "nav" .}}
    <h1>Metrics Overview</h1>
    <h2>Node: {{.NodeHostname}}</h2>

    <div class="metric-card">
        <h3>Metrics Explorer</h3>
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <select id="metric-selector" style="flex-grow: 1; padding: 8px; font-size: 14px;">
                <option value="">Select a metric to visualize...</option>
                {{range .MetricNames}}
                <option value="{{.}}">{{.}}</option>
                {{end}}
            </select>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="rate-toggle" style="width: auto;">
                <label for="rate-toggle" style="font-size: 0.9em; white-space: nowrap;">As Rate (/s)</label>
            </div>
            <button onclick="loadMetricData()" id="plot-button" style="padding: 8px 16px; background-color: var(--link-color); color: var(--bg-color); font-weight: bold; display: flex; gap: 8px; align-items: center;">
                <div id="plot-spinner" class="htmx-indicator" style="width: 14px; height: 14px; border-width: 2px;"></div>
                Plot
            </button>
        </div>
        <div style="height: 400px; position: relative;">
            <canvas id="explorerChart"></canvas>
            <div id="explorer-loading" class="htmx-indicator" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border-radius: var(--radius);">
                <div id="loading-spinner" style="width: 30px; height: 30px;"></div>
                <div style="margin-top: 10px; font-weight: 500;">Fetching metric data...</div>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem;">üìä</span> System Resources
            </h3>
            <div class="grid-4">
                <div>
                    <div class="metric-label">Normalized CPU</div>
                    <div class="metric-value">
                        {{if gt .CoreCount 0}}
                            {{printf "%.2f" (div .ResourceUsage.CPUPercentage (float64 .CoreCount))}}%
                            <div style="font-size: 0.75rem; color: var(--text-color-muted); font-weight: normal; margin-top: -4px;">
                                {{.CoreCount}} Cores
                            </div>
                        {{else}}
                            {{printf "%.2f" .ResourceUsage.CPUPercentage}}%
                        {{end}}
                    </div>
                </div>
                <div>
                    <div class="metric-label">Free Memory</div>
                    <div class="metric-value" style="font-size: 1.5rem;">{{formatBytesFloat (mul .ResourceUsage.FreeMemoryMB 1048576.0)}}</div>
                </div>
                <div>
                    <div class="metric-label">Free Disk</div>
                    <div class="metric-value" style="font-size: 1.5rem;">{{formatBytesFloat (mul .ResourceUsage.FreeSpaceMB 1048576.0)}}</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem;">üåê</span> Network & RPC
            </h3>
            <div class="grid-4">
                <div>
                    <div class="metric-label">Active RPC</div>
                    <div class="metric-value">{{printf "%.0f" .Network.ActiveConnections}}</div>
                </div>
                <div>
                    <div class="metric-label">RPC Errors</div>
                    <div class="metric-value" style="{{if gt .Network.RPCErrors 0.0}}color: #ef4444;{{end}}">
                        {{printf "%.0f" .Network.RPCErrors}}
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <div class="metric-label" style="margin-bottom: 0.5rem;">Raft Recovery</div>
                <div class="grid-3">
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-color-muted); text-transform: uppercase;">Pending Offsets</div>
                        <div style="font-size: 1.25rem; font-weight: 600; {{if gt .RaftRecovery.OffsetsPending 0.0}}color: #f59e0b;{{end}}">
                            {{if gt .RaftRecovery.OffsetsPending 1000000.0}}
                                {{printf "%.1fM" (div .RaftRecovery.OffsetsPending 1000000.0)}}
                            {{else}}
                                {{printf "%.0f" .RaftRecovery.OffsetsPending}}
                            {{end}}
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-color-muted); text-transform: uppercase;">Active Partitions</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">{{printf "%.0f" .RaftRecovery.PartitionsActive}}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; color: var(--text-color-muted); text-transform: uppercase;">To Recover</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">{{printf "%.0f" .RaftRecovery.PartitionsToRecover}}</div>
                    </div>
                </div>
            </div>
            
            {{if .Network.KafkaLatencies}}
            <div style="margin-top: 1.5rem;">
                <div class="metric-label" style="margin-bottom: 0.5rem;">Kafka Latency (Lifetime Avg)</div>
                <table style="font-size: 0.85rem; margin-bottom: 0; border: none;">
                    <thead>
                        <tr>
                            <th style="border: none; background: transparent; padding: 4px 8px;">Type</th>
                            <th style="border: none; background: transparent; padding: 4px 8px;">Latency</th>
                            <th style="border: none; background: transparent; padding: 4px 8px;">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Network.KafkaLatencies}}
                        <tr>
                            <td style="padding: 4px 8px; border: none;">{{.RequestType}}</td>
                            <td style="padding: 4px 8px; border: none; font-family: var(--font-mono);">{{printf "%.2f" (mul .AvgLatency 1000.0)}}ms</td>
                            <td style="padding: 4px 8px; border: none;">{{printf "%.0f" .Count}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            {{end}}
        </div>
    </div>

    {{if .PerformanceReport.NetworkReport}}
    <div class="metric-card">
        <h3 style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.25rem;">üì°</span> Network Stack Deep-Dive (SAR)
        </h3>
        <p style="font-size: 0.9em; color: var(--text-color-muted); margin-bottom: 1.5rem;">
            Deep analysis of network interface performance and TCP stack health.
        </p>
        
        <div class="grid-4" style="margin-bottom: 2rem;">
            <div>
                <div class="metric-label">Max Interface Util</div>
                <div class="metric-value {{if gt .PerformanceReport.NetworkReport.MaxInterfaceUtil 80.0}}text-danger{{else if gt .PerformanceReport.NetworkReport.MaxInterfaceUtil 50.0}}text-warning{{end}}">
                    {{printf "%.1f" .PerformanceReport.NetworkReport.MaxInterfaceUtil}}%
                </div>
            </div>
            <div>
                <div class="metric-label">Peak Throughput</div>
                <div class="metric-value">{{printf "%.1f" .PerformanceReport.NetworkReport.PeakThroughputMBps}} MB/s</div>
            </div>
            <div>
                <div class="metric-label">Peak TCP Retrans</div>
                <div class="metric-value {{if gt .PerformanceReport.NetworkReport.MaxRetransRate 5.0}}text-danger{{else if gt .PerformanceReport.NetworkReport.MaxRetransRate 1.0}}text-warning{{end}}">
                    {{printf "%.2f" .PerformanceReport.NetworkReport.MaxRetransRate}}/s
                </div>
            </div>
            <div>
                <div class="metric-label">Avg TCP Retrans</div>
                <div class="metric-value">{{printf "%.2f" .PerformanceReport.NetworkReport.AvgRetransRate}}/s</div>
            </div>
        </div>

        {{if or .PerformanceReport.NetworkReport.DetectedAnomalies .PerformanceReport.NetworkReport.Recommendations}}
        <div style="background: rgba(0,0,0,0.02); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--primary-color); margin-bottom: 1.5rem;">
            {{range .PerformanceReport.NetworkReport.DetectedAnomalies}}
                <div style="font-weight: 600; color: var(--text-color); margin-bottom: 0.25rem;">‚ö†Ô∏è {{.}}</div>
            {{end}}
            {{range .PerformanceReport.NetworkReport.Recommendations}}
                <div style="font-size: 0.9rem; color: var(--text-color-muted); margin-bottom: 0.5rem; padding-left: 1.5rem;">üí° {{.}}</div>
            {{end}}
        </div>
        {{end}}

        <div style="height: 300px;">
            <canvas id="sarNetChart"></canvas>
        </div>
        <script>
            (function() {
                const labels = [
                    {{range .SarData.Entries}}"{{.Timestamp.Format "15:04:05"}}",{{end}}
                ];
                const retrans = [{{range .SarData.Entries}}{{.TcpRetransRate}},{{end}}];
                const throughput = [{{range .SarData.Entries}}{{.PeakThroughputMBps}},{{end}}];

                function tryInit() {
                    if (window.initSarNetChart) {
                        window.initSarNetChart(labels, retrans, throughput);
                    } else {
                        setTimeout(tryInit, 50);
                    }
                }
                tryInit();
            })();
        </script>
    </div>
    {{end}}

    {{if .SarData.Entries}}
    <div class="metric-card">
        <h3>Historical CPU Usage (SAR)</h3>
        <div style="height: 300px;">
            <canvas id="sarCpuChart"></canvas>
        </div>
        <script>
            (function() {
                const labels = [
                    {{range .SarData.Entries}}"{{.Timestamp.Format "15:04:05"}}",{{end}}
                ];
                const userCpu = [{{range .SarData.Entries}}{{.CPUUser}},{{end}}];
                const sysCpu = [{{range .SarData.Entries}}{{.CPUSystem}},{{end}}];
                const idleCpu = [{{range .SarData.Entries}}{{.CPUIdle}},{{end}}];

                function tryInit() {
                    if (window.initSarChart) {
                        window.initSarChart(labels, userCpu, sysCpu, idleCpu);
                    } else {
                        setTimeout(tryInit, 50);
                    }
                }
                tryInit();
            })();
        </script>
    </div>
    {{end}}

    {{if .ShardCPU}}
    <div class="metric-card">
        <h3>CPU Usage by Shard (Core)</h3>
        <p><em>CPU utilization per shard (0-100%).</em></p>
        <div style="height: 300px;">
            <canvas id="shardCpuChart"></canvas>
        </div>
        <script>
            (function() {
                const labels = [
                    {{range .ShardCPU}}"Shard {{.ShardID}}",{{end}}
                ];
                const data = [
                    {{range .ShardCPU}}{{.Usage}},{{end}}
                ];

                function tryInit() {
                    if (window.initShardCpuChart) {
                        window.initShardCpuChart(labels, data);
                    } else {
                        setTimeout(tryInit, 50);
                    }
                }
                tryInit();
            })();
        </script>
    </div>
    {{end}}

    {{if .IOMetrics}}
    <div class="metric-card">
        <h3>IO Operations</h3>
        <p style="font-size: 0.9em; color: var(--text-color-muted);">
            High IO skew between shards usually indicates hot partitions.
        </p>
        <table class="sortable-table" id="io-table">
            <thead>
                <tr>
                    <th>Shard</th>
                    <th>IO Class</th>
                    <th>Read Ops</th>
                    <th>Write Ops</th>
                </tr>
            </thead>
            <tbody>
                {{$maxRead := .MaxReadOps}}
                {{$maxWrite := .MaxWriteOps}}
                {{range .IOMetrics}}
                <tr>
                    <td>{{.ShardID}}</td>
                    <td>
                        {{if eq .Class "raft"}}
                            <div class="tooltip-container">
                                raft ‚ÑπÔ∏è
                                <span class="tooltip-text">Write-Ahead Log (Consensus). High writes are normal.</span>
                            </div>
                        {{else if eq .Class "kafka_read"}}
                            <div class="tooltip-container">
                                kafka_read ‚ÑπÔ∏è
                                <span class="tooltip-text">Consumer Fetch requests.</span>
                            </div>
                        {{else if eq .Class "compaction"}}
                            <div class="tooltip-container">
                                compaction ‚ÑπÔ∏è
                                <span class="tooltip-text">Log cleanup/retention. Background task.</span>
                            </div>
                        {{else if eq .Class "default"}}
                            <div class="tooltip-container">
                                default ‚ÑπÔ∏è
                                <span class="tooltip-text">General system I/O (startup, misc).</span>
                            </div>
                        {{else}}
                            {{.Class}}
                        {{end}}
                    </td>
                    <td style="position: relative;">
                        {{if gt $maxRead 0.0}}
                        <div style="position: absolute; left: 0; top: 10%; bottom: 10%; background: rgba(54, 162, 235, 0.2); width: {{printf "%.1f" (mul (div .ReadOps $maxRead) 100)}}%; border-radius: 4px;"></div>
                        {{end}}
                        <span style="position: relative; z-index: 1;" class="fmt-num">{{printf "%.0f" .ReadOps}}</span>
                    </td>
                    <td style="position: relative;">
                        {{if gt $maxWrite 0.0}}
                        <div style="position: absolute; left: 0; top: 10%; bottom: 10%; background: rgba(255, 99, 132, 0.2); width: {{printf "%.1f" (mul (div .WriteOps $maxWrite) 100)}}%; border-radius: 4px;"></div>
                        {{end}}
                        <span style="position: relative; z-index: 1;" class="fmt-num">{{printf "%.0f" .WriteOps}}</span>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        <script>
            document.querySelectorAll('.fmt-num').forEach(el => {
                const num = parseFloat(el.innerText);
                if (!isNaN(num)) {
                    el.innerText = num.toLocaleString();
                }
            });
        </script>
    </div>
    {{end}}

</body>
</html>